<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Пожарная доска — Incident Command Board</title>
<style>
  :root{
    --bg:#0f1720; --card:#111827; --muted:#9aa4b2; --accent:#ef4444; --accent-2:#f59e0b;
    --glass: rgba(255,255,255,0.03);
    font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #0b1a26 100%);color:#e6eef6}
  .container{max-width:1200px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:18px}
  header{grid-column:1/-1;display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:20px;letter-spacing:0.2px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button, .small{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent),#ff6b6b);color:white;border:none}
  .board{display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;gap:12px;align-items:center}
  .timer{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .columns{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
  .col{min-width:280px;background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .col h3{margin:0 0 8px 0;font-size:15px}
  .task{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.02);cursor:grab;display:flex;gap:8px;align-items:flex-start}
  .task .left{flex:1}
  .task .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .task.done{opacity:0.6;text-decoration:line-through}
  .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .teams{display:grid;gap:8px}
  .team{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
  footer{grid-column:1/-1;margin-top:6px;text-align:center;color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px}
  .small-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
  .top-actions{display:flex;gap:8px}
  .count{font-size:11px;color:var(--muted);padding-left:6px}
  @media (max-width:960px){.container{grid-template-columns:1fr;}.sidebar{order:2}}
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div>
      <h1>Пожарная доска — Incident Command Board</h1>
      <div style="color:var(--muted);font-size:13px">Быстрое управление задачами и командами на инциденте</div>
    </div>
    <div class="controls">
      <div class="timer" id="timerDisplay">00:00:00</div>
      <div class="top-actions">
        <button class="small" id="startTimer">Start</button>
        <button class="small" id="pauseTimer">Pause</button>
        <button class="small" id="resetTimer">Reset</button>
      </div>
      <button class="primary" id="exportBtn">Экспорт</button>
    </div>
  </header>

  <main class="board">
    <div class="topbar">
      <div style="display:flex;gap:8px;align-items:center">
        <label style="margin:0"><strong>Инцидент:</strong></label>
        <input type="text" id="incidentName" value="Fire — Downtown" style="width:260px"/>
      </div>
      <div style="display:flex;gap:8px;margin-left:12px;align-items:center">
        <label style="margin:0">Уровень:</label>
        <select id="incidentLevel">
          <option>1 — Малый</option>
          <option selected>2 — Средний</option>
          <option>3 — Крупный</option>
        </select>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="small" id="addCategoryBtn">Добавить категорию</button>
        <button class="small" id="addTaskBtn">Добавить задачу</button>
      </div>
    </div>

    <div class="columns" id="columns">
      <!-- Dynamic columns -->
    </div>
  </main>

  <aside class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <strong>Команды / Ресурсы</strong>
      <button class="small" id="addTeamBtn">Добавить</button>
    </div>

    <div class="teams" id="teamsList">
      <!-- Teams -->
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>
    <div>
      <label>Импорт состояния (JSON)</label>
      <textarea id="importJson" rows="4" placeholder='Вставьте JSON и нажмите "Импорт"'></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="small" id="importBtn">Импорт</button>
        <button class="small" id="printBtn">Печать</button>
      </div>
    </div>
  </aside>

  <footer>
    Подсказка: перетаскивайте задачи между колонками. Нажмите на задачу — чтобы пометить выполненной или назначить команду.
  </footer>
</div>

<script>
/*
  Simple front-end incident board.
  Data model in memory. No backend — export/import JSON to save state.
*/

const defaultState = {
  incident: {name:'Fire — Downtown', level:'2 — Средний', startedAt: null, timer:0, running:false},
  teams: [
    {id:genId(),'name':'Engine 1','type':'Engine','status':'Available','notes':''},
    {id:genId(),'name':'Tower 1','type':'Tower','status':'Available','notes':''},
    {id:genId(),'name':'Battalion 1','type':'Battalion','status':'On Scene','notes':''}
  ],
  categories: [
    {id:genId(),title:'Recon / Size-Up', tasks:[
      {id:genId(),title:'Conduct 360° size-up',assigned:null,done:false,notes:'Check exposures'},
      {id:genId(),title:'Report conditions to Command',assigned:'Battalion 1',done:false,notes:''}
    ]},
    {id:genId(),title:'Fire Attack', tasks:[
      {id:genId(),title:'Deploy attack line',assigned:'Engine 1',done:false,notes:'1.75" hose'},
    ]},
    {id:genId(),title:'Rescue / Medical', tasks:[]},
    {id:genId(),title:'Safety', tasks:[]}
  ]
};

let state = loadState() || defaultState;
const columnsEl = document.getElementById('columns');
const teamsListEl = document.getElementById('teamsList');
const incidentNameInput = document.getElementById('incidentName');
const incidentLevelInput = document.getElementById('incidentLevel');
const timerDisplay = document.getElementById('timerDisplay');

function genId(){ return 'id_'+Math.random().toString(36).slice(2,9) }

function saveState(){
  localStorage.setItem('icb_state', JSON.stringify(state));
}
function loadState(){
  try{ return JSON.parse(localStorage.getItem('icb_state')) }catch(e){return null}
}

function render(){
  // incident header
  incidentNameInput.value = state.incident.name;
  incidentLevelInput.value = state.incident.level;
  // columns
  columnsEl.innerHTML = '';
  state.categories.forEach(cat=>{
    const col = document.createElement('div'); col.className='col'; col.dataset.cat=cat.id;
    const h = document.createElement('h3'); h.textContent = cat.title;
    const rename = document.createElement('button'); rename.className='small'; rename.textContent='✎'; rename.style=float='right';
    rename.onclick = ()=>{ const nv = prompt('Название категории', cat.title); if(nv){cat.title=nv; saveState(); render()}};
    const addT = document.createElement('button'); addT.className='small'; addT.textContent='+ Задача';
    addT.onclick = ()=>{ createTask(cat.id) };
    const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.gap='8px'; hdr.style.justifyContent='space-between';
    hdr.appendChild(h); const right = document.createElement('div'); right.appendChild(addT);
    col.appendChild(hdr);
    // tasks
    const list = document.createElement('div'); list.style.minHeight='60px';
    cat.tasks.forEach(t=>{
      const task = document.createElement('div'); task.className='task'; task.draggable=true; task.dataset.tid=t.id;
      if(t.done) task.classList.add('done');
      const left = document.createElement('div'); left.className='left';
      const title = document.createElement('div'); title.textContent = t.title;
      const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `${t.assigned?'<strong>'+t.assigned+'</strong> • ':''}${t.notes||''}`;
      left.appendChild(title); left.appendChild(meta);
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
      const doneBtn = document.createElement('button'); doneBtn.className='small small-ghost'; doneBtn.textContent = t.done?'⤺':'✓';
      doneBtn.onclick = (e)=>{ e.stopPropagation(); t.done = !t.done; saveState(); render(); };
      const assignBtn = document.createElement('button'); assignBtn.className='small small-ghost'; assignBtn.textContent='Assign';
      assignBtn.onclick = (e)=>{ e.stopPropagation(); assignTask(t.id); };
      const editBtn = document.createElement('button'); editBtn.className='small small-ghost'; editBtn.textContent='⋯';
      editBtn.onclick = (e)=>{ e.stopPropagation(); editTask(t.id, cat.id) };
      actions.appendChild(doneBtn); actions.appendChild(assignBtn); actions.appendChild(editBtn);
      task.appendChild(left); task.appendChild(actions);
      // drag events
      task.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id,fromCat:cat.id})); ev.dataTransfer.effectAllowed='move' });
      list.appendChild(task);
    });
    col.appendChild(list);
    // column-level drop handling
    col.addEventListener('dragover', ev=>{ ev.preventDefault(); ev.dataTransfer.dropEffect='move' });
    col.addEventListener('drop', ev=>{
      ev.preventDefault();
      const data = JSON.parse(ev.dataTransfer.getData('text/plain'));
      moveTask(data.taskId, data.fromCat, cat.id);
    });
    columnsEl.appendChild(col);
  });

  // teams
  teamsListEl.innerHTML='';
  state.teams.forEach(t=>{
    const el = document.createElement('div'); el.className='team';
    el.innerHTML = `<div><strong>${t.name}</strong><div style="font-size:12px;color:var(--muted)">${t.type} • ${t.status}</div></div>
    <div style="display:flex;gap:6px"><button class="small small-ghost">✎</button><button class="small small-ghost">⋮</button></div>`;
    const editBtn = el.querySelector('button');
    editBtn.onclick = ()=>{ const nv = prompt('Название команды', t.name); if(nv){t.name=nv; saveState(); render()} };
    teamsListEl.appendChild(el);
  });

  saveState();
  updateTimerUI();
}

function createTask(catId){
  const title = prompt('Название задачи');
  if(!title) return;
  const category = state.categories.find(c=>c.id===catId);
  category.tasks.unshift({id:genId(),title,assigned:null,done:false,notes:''});
  saveState(); render();
}

function assignTask(taskId){
  const taskInfo = findTask(taskId);
  const options = state.teams.map((t,i)=>`${i+1}. ${t.name} (${t.type})`).join('\n');
  const choice = prompt('Назначить команду:\n'+options+'\nВведите номер, или оставьте пустым для отмены');
  if(!choice) return;
  const idx = parseInt(choice)-1;
  if(state.teams[idx]){ taskInfo.task.assigned = state.teams[idx].name; saveState(); render(); }
}

function editTask(taskId, catId){
  const info = findTask(taskId);
  const nv = prompt('Редактировать задачу (название)', info.task.title);
  if(nv!==null){ info.task.title = nv; saveState(); render(); }
}

function moveTask(taskId, fromCatId, toCatId){
  if(fromCatId===toCatId) return;
  const from = state.categories.find(c=>c.id===fromCatId);
  const to = state.categories.find(c=>c.id===toCatId);
  const idx = from.tasks.findIndex(t=>t.id===taskId);
  if(idx>-1){
    const [task] = from.tasks.splice(idx,1);
    to.tasks.unshift(task);
    saveState(); render();
  }
}

function findTask(taskId){
  for(const c of state.categories){
    const t = c.tasks.find(x=>x.id===taskId);
    if(t) return {cat:c,task:t};
  }
  return null;
}

// UI actions
document.getElementById('addCategoryBtn').onclick = ()=>{
  const name = prompt('Название новой категории');
  if(!name) return;
  state.categories.push({id:genId(),title:name,tasks:[]});
  saveState(); render();
};

document.getElementById('addTaskBtn').onclick = ()=>{
  const catTitle = state.categories[0]?.title || 'General';
  const catId = state.categories[0]?.id;
  const t = prompt('Название задачи (будет в категории: '+catTitle+')');
  if(!t) return;
  state.categories[0].tasks.unshift({id:genId(),title:t,assigned:null,done:false,notes:''});
  saveState(); render();
};

document.getElementById('addTeamBtn').onclick = ()=>{
  const name = prompt('Имя команды (например Engine 1)');
  if(!name) return;
  const type = prompt('Тип (Engine/Tower/Battalion/EMS)', 'Engine') || 'Engine';
  state.teams.push({id:genId(),name,type,status:'Available',notes:''});
  saveState(); render();
};

document.getElementById('exportBtn').onclick = ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='incident_state.json'; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('importBtn').onclick = ()=>{
  const val = document.getElementById('importJson').value.trim();
  if(!val) return alert('Вставьте JSON');
  try{
    const parsed = JSON.parse(val);
    state = parsed;
    saveState(); render();
    alert('Импортировано');
  }catch(e){ alert('Ошибка JSON: '+e.message) }
};

document.getElementById('printBtn').onclick = ()=>{ window.print() };

incidentNameInput.addEventListener('change', ()=>{ state.incident.name = incidentNameInput.value; saveState() });
incidentLevelInput.addEventListener('change', ()=>{ state.incident.level = incidentLevelInput.value; saveState() });

// Timer
let timerInterval = null;
function startTimer(){
  if(state.incident.running) return;
  state.incident.running = true;
  if(!state.incident.startedAt) state.incident.startedAt = Date.now() - (state.incident.timer||0);
  timerInterval = setInterval(()=> {
    state.incident.timer = Date.now() - state.incident.startedAt;
    updateTimerUI();
  }, 500);
  saveState();
}
function pauseTimer(){
  if(!state.incident.running) return;
  state.incident.running = false;
  clearInterval(timerInterval); timerInterval = null;
  saveState();
}
function resetTimer(){
  state.incident.running = false;
  clearInterval(timerInterval); timerInterval = null;
  state.incident.startedAt = null; state.incident.timer = 0;
  updateTimerUI(); saveState();
}
function updateTimerUI(){
  const ms = state.incident.timer || 0;
  const s = Math.floor(ms/1000)%60; const m = Math.floor(ms/60000)%60; const h = Math.floor(ms/3600000);
  timerDisplay.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('startTimer').disabled = state.incident.running;
  document.getElementById('pauseTimer').disabled = !state.incident.running;
}

document.getElementById('startTimer').addEventListener('click', startTimer);
document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
document.getElementById('resetTimer').addEventListener('click', resetTimer);

// helper to find initial task by id for some actions
function init(){
  render();
  // start timer if it was running before
  if(state.incident.running) startTimer();
}

init();
</script>
</body>
</html>
